<!DOCTYPE html>

<head>
    <title>RanIDE Demo</title>
    <meta charset="UTF-8" />
    <script src="/static/vue.js" type="text/javascript"></script>
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <script src="/static/axios.js" type="text/javascript"></script>
    <link rel="shortcut icon" href="/static/img/ran.ico" type="image/x-icon" />
    <link data-name="vs/editor/editor.main" rel="stylesheet" href="/static/monaco-editor/min/vs/editor/editor.main.css">
    <script src="/static/monaco-editor/min/vs/loader.js" type="text/javascript"></script>
    <script src="/static/monaco-editor/min/vs/editor/editor.main.nls.js"></script>
    <script src="/static/monaco-editor/min/vs/editor/editor.main.js"></script>
    <link rel="stylesheet" type="text/css" href="/static/projectManagement.css" />
    <script src="https://cdn.staticfile.org/jquery/1.10.2/jquery.min.js"></script>
</head>

<body>
    <main>
        <el-container>
            <div id="menu" v-show="showMenu" ref="showPanel" @click.prevent="handleMenu">
                <el-cascader-panel ref="cas-menu" :options="options" size="medium"></el-cascader-panel>
            </div>
            <el-aside>
                <div style="margin-top: 40px;">
                    <div>
                        <el-tree 
                        :data="files" :props="defaultProps" @node-contextmenu.prevent="openMenu" default-expand-all>
                        <span slot-scope="{node, data}">
                            <i v-if="data.type === 'dir'" class="el-icon-folder"></i>
                            <i v-else class="el-icon-python"></i>
                            <span style="margin-left: 10%">{[node.label]}</span>
                        </span>
                        </el-tree>
                    </div>
                </div>
            </el-aside>
            <el-main>
                <el-upload :action="action" :http-request="importData" style="display:none">
                    <el-button size="small" type="primary" id='upload_btn'>点击上传</el-button>
                </el-upload>
            </el-main>
        </el-container>
    </main>
</body>

<script type="text/javascript">
    var params = location.search;
    var projectname = params.split("=")[1]
    //解码中文路径
    projectname = decodeURIComponent(decodeURIComponent(projectname))
    console.log(projectname)
    var codepage = new Vue({
        delimiters: ["{[", "]}"],
        el: "main",
        data: {
            projectName: projectname, //当前打开的项目的名字
            showMenu: false, //控制文件树右键点击菜单的显示
            files: [], //项目"文件夹
            filenode: {
                label: "label",
                children: [],
                path: "path",
                type: "dir",
            },
            defaultProps: {
                label: "label",
                children: 'children',
                path: "path",
                type: "dir",
                lang: '',
            },
            options: [],
            // 对文件的几种操作
            options1: [
                {
                    value: 'open',
                    label: '打开',
                },
                {
                    value: 'download',
                    label: '下载',
                },
                {
                    value: 'rename',
                    label: '重命名',
                },
                {
                    value: 'remove',
                    label: '删除',
                },
            ],
            // 对文件夹的几种操作
            options2: [
                {
                    value: 'rename',
                    label: '重命名',
                },
                {
                    value: 'remove',
                    label: '删除',
                },
                {
                    value: 'newdir',
                    label: '新建目录',
                },
                {
                    value: 'newfile',
                    label: '新建文件',
                },
                {
                    value: 'upload',
                    label: '上传文件',
                },
            ]

        },
        methods: {
            closeMenu() {
                this.showMenu = false;
            },
            handleMenu() {
                const value = this.$refs["cas-menu"].getCheckedNodes()[0].data.value;  //获取所选中操作的类型
                console.log(value);
                // 打开文件到右侧代码编辑区
                if (value === 'open') {
                    ///
                    filepath = this.filenode.path;
                }
                // 下载文件
                else if (value === 'download') {
                    label = this.filenode.label
                    axios({
                        method: 'post',
                        url: '/downloadFile',
                        data: {
                            path: this.filenode.path
                        },
                        responseType: 'blob'
                    })
                        .then(function (response) {
                            const blobUrl = window.URL.createObjectURL(response.data)
                            const a = document.createElement('a')
                            a.style.display = 'none'
                            a.download = label
                            a.href = blobUrl
                            a.click()
                        })
                        .catch(function (error) {
                            console.log(error);
                        });
                }
                // 重命名文件
                else if (value === 'rename') {
                    console.log("rename");
                    this.$prompt('请输入新的文件名/目录名', '重命名', {
                        confirmButtonText: '确定',
                        cancelButtonText: '取消',
                        inputErrorMessage: '输入不正确',
                    }).then(({ value }) => {
                        axios({
                            method: 'post',
                            url: '/rename',
                            data: {
                                filenode: this.filenode,
                                newname: value
                            }
                        })
                            .then((res) => {
                                this.getFileTree();
                            })
                            .catch((err) => {
                                console.error(err);
                            });
                    }).catch(() => {
                        this.$message({
                            type: 'info',
                            message: '取消输入'
                        });
                    });
                }
                else if (value === 'remove') {
                    axios({
                        method: 'post',
                        url: '/remove',
                        data: {
                            filenode: this.filenode,
                        }
                    })
                        .then((res) => {
                            this.getFileTree();
                        })
                        .catch((err) => {
                            console.error(err);
                        });
                }
                else if (value === 'newdir') {
                    console.log("newdir");
                    this.$prompt('请输入新建目录名', '新建目录', {
                        confirmButtonText: '确定',
                        cancelButtonText: '取消',
                        inputErrorMessage: '输入不正确',
                    }).then(({ value }) => {
                        axios({
                            method: 'post',
                            url: '/newdir',
                            data: {
                                filenode: this.filenode,
                                name: value
                            }
                        })
                            .then((res) => {
                                this.getFileTree();
                            })
                            .catch((err) => {
                                console.error(err);
                            });
                    }).catch(() => {
                        this.$message({
                            type: 'info',
                            message: '取消输入'
                        });
                    });
                }
                else if (value === 'newfile') {
                    console.log("newfile");
                    this.$prompt('请输入新建文件名', '新建文件', {
                        confirmButtonText: '确定',
                        cancelButtonText: '取消',
                        inputErrorMessage: '输入不正确',
                    }).then(({ value }) => {
                        axios({
                            method: 'post',
                            url: '/newfile',
                            data: {
                                filenode: this.filenode,
                                name: value
                            }
                        })
                            .then((res) => {
                                this.getFileTree();
                            })
                            .catch((err) => {
                                console.error(err);
                            });
                    }).catch(() => {
                        this.$message({
                            type: 'info',
                            message: '取消输入'
                        });
                    });
                }
                else if (value === 'upload') {
                    document.getElementById('upload_btn').click();
                }

                this.showMenu = false;
            },
            getFileTree() {
                axios
                    .post('/getFiletree',
                        { projectname: this.projectName })
                    .then((res) => {
                        this.files = [res.data['files']];
                        console.log(this.files);
                    })
                    .catch((err) => {
                        console.error(err);
                    });
            },
            openMenu(event, data) {
                this.filenode = data;
                console.log("openmenu");
                var m = document.getElementById('menu');
                this.filenode = data;
                if (data.type === 'dir') {
                    console.log("dirmenu")
                    this.options = this.options2;
                    // 确定菜单框出现的位置，不知道为什么目前无效果；
                    m.style.top = event.clientY + 'px';
                    console.log(m.style.top);
                    m.style.left = event.clientX + 'px';
                }
                else {
                    this.options = this.options1;
                    m.style.top = event.clientY + 'px';
                    m.style.left = event.clientX + 'px';
                }
                this.showMenu = true;
            },
            importData(item) {
                console.log("upload");
                let formData = new FormData()
                formData.append('file', item.file)
                formData.append('path', this.filenode.path)
                console.log(item.file)
                axios({
                    method: 'post',
                    url: '/upload',
                    data: formData,
                    headers: { 'Content-Type': 'multipart/form-data;boundary = ' + new Date().getTime() }
                })
                    .then((res) => {
                        this.getFileTree();
                    })
                    .catch((err) => {
                        console.error(err);
                    });
            },
        },
        mounted() {
            this.getFileTree();
        },
        created() {
            document.addEventListener('click', (e) => {
                if (this.$refs.showPanel) {
                    let isSelf = this.$refs.showPanel.contains(e.target)
                    if (!isSelf) {
                        this.showMenu = false
                    }
                }
            })
        }
    });
</script>